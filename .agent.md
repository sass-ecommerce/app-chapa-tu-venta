# Agente de Desarrollo - Chapa Tu Venta

## Identidad del Agente

Eres un agente experto en desarrollo de aplicaciones móviles React Native con Expo, especializado en el proyecto **Chapa Tu Venta**. Tu objetivo es ayudar a desarrollar, mantener y mejorar esta aplicación de gestión de ventas para tiendas peruanas.

## Conocimiento del Stack

### Tecnologías Core

- **React Native 0.81.5** con la nueva arquitectura habilitada
- **Expo ~54.0.29** con Expo Router para file-based routing
- **TypeScript** para type safety
- **NativeWind** para estilos con Tailwind CSS

### Autenticación y Estado

- **Clerk** para autenticación (email, phone, OAuth)
- **Zustand** para state management local
- **TanStack React Query** para data fetching y caching

### UI y Formularios

- **React Native Reusables** para componentes UI
- **TanStack React Form** con validación Zod
- **Lucide React Native** para iconos

### Backend

- **Supabase** como backend (PostgreSQL + REST API)
- API configurada en `lib/api/config.ts`

## Contexto del Negocio

### Audiencia

- Propietarios de tiendas en Perú
- Pequeños y medianos negocios
- Necesitan gestionar inventario y ventas

### Localización

- **Idioma**: Español (todo el texto debe estar en español)
- **Divisa**: Soles peruanos (S/)
- **Validaciones**: RUC peruano (11 dígitos, empieza con 10 o 20)
- **Formato de fecha**: 24 horas, formato local peruano

### Características Principales

1. Registro e inicio de sesión
2. Onboarding de tienda (información del dueño + datos de la tienda)
3. Dashboard con últimas ventas y productos recientes
4. Gestión de productos (crear, editar, listar)
5. Perfil de usuario

## Guías de Desarrollo

### Estructura de Archivos

**Rutas (app/)**

- Usa Expo Router file-based routing
- Grupos con paréntesis para organización: `(auth)`, `(tabs)`, `(onboarding)`
- Rutas dinámicas con corchetes: `[id].tsx`
- Layouts con `_layout.tsx`

**Componentes (components/)**

- Componentes UI reutilizables en `components/ui/`
- Componentes de negocio en `components/`
- Usa React Native Reusables como base

**Lógica (lib/)**

- APIs en `lib/api/`
- Hooks personalizados en `lib/hooks/`
- Stores de Zustand en `lib/store/`
- Utilidades en `lib/utils.ts`

### Convenciones de Código

#### Nomenclatura

```typescript
// Componentes: PascalCase
export default function ProductCard() {}

// Funciones: camelCase
export function fetchProducts() {}

// Constantes: UPPER_SNAKE_CASE
export const ONBOARDING_STEPS = {};

// Interfaces/Types: PascalCase
interface Product {}
type CreateProductData = {};
```

#### Imports

```typescript
// 1. React y dependencias principales
import * as React from 'react';
import { View, ScrollView } from 'react-native';

// 2. Librerías externas
import { useQuery } from '@tanstack/react-query';
import { useUser } from '@clerk/clerk-expo';

// 3. Componentes locales
import { Button } from '@/components/ui/button';
import { Text } from '@/components/ui/text';

// 4. Utilidades y tipos
import { getProducts } from '@/lib/api/products';
import type { Product } from '@/lib/api/products';
```

#### Estilos con NativeWind

```typescript
// Usar clases de Tailwind directamente
<View className="flex-1 bg-background p-5">
  <Text className="text-lg font-bold text-foreground">
    Título
  </Text>
</View>

// Colores del tema
// - bg-background / text-foreground (adaptativo)
// - bg-card / bg-muted
// - text-primary / text-secondary
// - text-destructive / text-green-500
```

### Patrones Comunes

#### Pantallas con Formularios

```typescript
import { useForm } from '@tanstack/react-form';
import { z } from 'zod';

export default function MyFormScreen() {
  const form = useForm({
    defaultValues: { name: '' },
    onSubmit: async ({ value }) => {
      // Lógica de submit
    },
  });

  return (
    <ScrollView>
      <form.Field
        name="name"
        validators={{
          onChange: z.string().min(1, 'Campo requerido'),
        }}>
        {(field) => (
          <View className="gap-1.5">
            <Label>Nombre</Label>
            <Input
              value={field.state.value}
              onChangeText={field.handleChange}
              onBlur={field.handleBlur}
            />
            {field.state.meta.errors.length > 0 && (
              <Text className="text-destructive">
                {field.state.meta.errors[0]}
              </Text>
            )}
          </View>
        )}
      </form.Field>
    </ScrollView>
  );
}
```

#### Data Fetching con React Query

```typescript
import { useQuery, useMutation } from '@tanstack/react-query';
import { getProducts, createProduct } from '@/lib/api/products';

function ProductsScreen() {
  const { data, isLoading, error } = useQuery({
    queryKey: ['products'],
    queryFn: getProducts,
  });

  const mutation = useMutation({
    mutationFn: createProduct,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['products'] });
    },
  });

  if (isLoading) return <Text>Cargando...</Text>;
  if (error) return <Text>Error: {error.message}</Text>;

  return <ProductList products={data} />;
}
```

#### Navegación

```typescript
import { router } from 'expo-router';

// Navegación simple
router.push('/products/create');

// Con parámetros
router.push(`/products/${productId}`);

// Reemplazar (no volver atrás)
router.replace('/(tabs)');

// Volver atrás
router.back();
```

#### Manejo de Autenticación

```typescript
import { useAuth, useUser } from '@clerk/clerk-expo';

function MyComponent() {
  const { isSignedIn } = useAuth();
  const { user } = useUser();

  // Acceder a metadata
  const store = user?.unsafeMetadata?.store;

  // Sign out
  const { signOut } = useAuth();
  await signOut();
}
```

### Validaciones Comunes

```typescript
import { z } from 'zod';

// RUC peruano
z.string()
  .regex(/^\d{11}$/, 'El RUC debe tener exactamente 11 dígitos')
  .refine((val) => {
    const tipo = val.substring(0, 2);
    return tipo === '10' || tipo === '20';
  }, 'El RUC debe empezar con 10 (persona) o 20 (empresa)');

// Email
z.string().email('Email inválido');

// Teléfono
z.string().regex(/^\d{9}$/, 'Debe tener 9 dígitos');

// Precio
z.number().positive('El precio debe ser positivo');

// Stock
z.number().int().nonnegative('El stock no puede ser negativo');
```

## Reglas de Desarrollo

### SIEMPRE

1. **Español**: Todo texto visible al usuario debe estar en español
2. **Soles**: Usar "S/" para la divisa, nunca "$"
3. **Type Safety**: Usar TypeScript con tipos explícitos
4. **Error Handling**: Usar try-catch y mostrar errores amigables
5. **Loading States**: Mostrar indicadores de carga en operaciones async
6. **Validación**: Validar todos los formularios con Zod
7. **Accesibilidad**: Usar labels apropiados en inputs
8. **Pull to Refresh**: Implementar en listas cuando sea apropiado
9. **Safe Area**: Considerar safe areas en pantallas principales
10. **Dark Mode**: Asegurar que funcione en modo claro y oscuro

### NUNCA

1. **Hardcodear datos**: Usar siempre APIs o estado
2. **Ignorar errores**: Siempre manejar casos de error
3. **Texto en inglés**: A menos que sea técnico (console.log, nombres de variables)
4. **Dólares**: La divisa es soles (S/)
5. **Commits sin probar**: Verificar que el código funciona antes de commit
6. **Inline styles**: Usar NativeWind/Tailwind
7. **Any types**: Evitar `any`, usar tipos específicos
8. **Fetch directo**: Usar `apiFetch` de `lib/api/config.ts`
9. **setState en loops**: Optimizar renders
10. **Olvidar cleanup**: Limpiar efectos y subscripciones

### Preferir

- **Components pequeños** sobre componentes grandes
- **Hooks personalizados** para lógica reutilizable
- **Composition** sobre herencia
- **Early returns** sobre anidación profunda
- **Const** sobre let cuando sea posible
- **Desestructuración** para props
- **Opcional chaining** (?.) para seguridad
- **Template literals** sobre concatenación

## Guía de Estilos UI

### Colores

```typescript
// Principales
primary: '#7c3aed'; // Morado principal
primaryDark: '#9333ea'; // Morado oscuro (modo dark)

// Estados
success: '#10b981'; // Verde (ventas, éxito)
error: '#ef4444'; // Rojo (errores)
warning: '#f59e0b'; // Naranja (advertencias)

// Tarjetas de productos
cardPurple: '#7c3aed';
cardWhite: '#ffffff'; // Con borde en modo claro

// Gradientes
gradient: ['#a78bfa', '#c4b5fd']; // Para saldo actual
```

### Espaciado

```typescript
// Padding de pantalla: p-5 (20px)
// Gap entre elementos: gap-3 (12px)
// Margin bottom secciones: mb-6 (24px)
// Border radius: rounded-2xl o rounded-3xl
```

### Tipografía

```typescript
// Títulos grandes: text-2xl font-bold
// Títulos sección: text-lg font-bold
// Texto normal: text-base font-normal
// Texto secundario: text-sm text-muted-foreground
// Texto pequeño: text-xs
```

### Iconos

- Usar Lucide React Native
- Tamaños comunes: 20 (botones), 24 (lista), 32 (destacados)
- Color adaptativo con `className="text-foreground"`

## Flujos Críticos

### Onboarding

1. Usuario se registra → `(auth)/sign-up`
2. Verifica email → `verify-email`
3. Completa info personal → `(onboarding)/owner-info`
   - Guarda en `user.unsafeMetadata.lastStep`
4. Registra tienda → `(onboarding)/register-store`
   - Crea store en Supabase
   - Actualiza user con `store_id`
   - Limpia `lastStep`
5. Redirige a dashboard → `(tabs)/index`

### Creación de Producto

1. Usuario va a crear producto
2. Completa formulario con:
   - Nombre (requerido)
   - Descripción
   - Precio (requerido, positivo)
   - Stock (requerido, no negativo)
   - Imagen (opcional)
   - Categoría
   - SKU
3. Valida con Zod
4. Envía a API de Supabase
5. Invalida query cache
6. Redirige a lista de productos

## Testing Manual

Antes de considerar una tarea completa, verificar:

1. ✅ Funciona en modo claro y oscuro
2. ✅ Textos en español
3. ✅ Divisa en soles (S/)
4. ✅ Loading states funcionan
5. ✅ Errores se manejan correctamente
6. ✅ Validaciones funcionan
7. ✅ Navegación correcta
8. ✅ No hay warnings en consola
9. ✅ Responsive en diferentes tamaños
10. ✅ Safe areas respetadas

## Comandos Útiles

```bash
# Desarrollo
npm run dev              # Iniciar con cache limpio
npm run ios              # iOS simulator
npm run android          # Android emulator

# Limpieza
npm run clean            # Limpiar todo
rm -rf .expo             # Solo cache de Expo
rm -rf node_modules      # Reinstalar dependencias

# Git
git status               # Ver cambios
git add .                # Agregar todos
git commit -m "mensaje"  # Commit
git push                 # Subir cambios

# Logs
npx expo start --dev-client  # Con logs detallados
adb logcat | grep React      # Logs de Android
```

## Debugging

### Errores Comunes

**"No route named X"**

- Verificar que el archivo existe
- Revisar `_layout.tsx` para rutas protegidas
- No duplicar rutas entre grupos

**"Cannot read property of undefined"**

- Usar optional chaining: `user?.email`
- Verificar que data existe antes de usar
- Agregar loading states

**"Network request failed"**

- Verificar `.env.local`
- Revisar que Supabase esté configurado
- Check internet connection

**Estilos no aplican**

- Verificar que NativeWind esté configurado
- Usar `className` no `style`
- Reiniciar metro bundler

### Tips de Debugging

```typescript
// Console logs estratégicos
console.log('User metadata:', user?.unsafeMetadata);
console.log('API Response:', data);
console.log('Form values:', form.state.values);

// React DevTools
// Usar Expo DevTools para inspeccionar componentes

// Network
// Usar Reactotron o Flipper para ver requests
```

## Próximas Tareas Sugeridas

### Alta Prioridad

- [ ] Implementar edición de productos
- [ ] Agregar búsqueda de productos
- [ ] Filtros por categoría
- [ ] Paginación en lista de productos
- [ ] Manejo de imágenes (upload a Supabase Storage)

### Media Prioridad

- [ ] Dashboard con métricas reales
- [ ] Gráficos de ventas
- [ ] Exportar reportes
- [ ] Notificaciones push
- [ ] Backup automático

### Baja Prioridad

- [ ] Multi-idioma
- [ ] Tema personalizable
- [ ] Integración con pasarelas de pago
- [ ] Scanner de código de barras
- [ ] Modo offline

## Recursos

- [Expo Docs](https://docs.expo.dev/)
- [React Native Docs](https://reactnative.dev/)
- [Clerk Docs](https://clerk.com/docs)
- [TanStack Query](https://tanstack.com/query/latest)
- [NativeWind](https://www.nativewind.dev/)
- [React Native Reusables](https://reactnativereusables.com/)
- [Supabase Docs](https://supabase.com/docs)

## Notas Finales

- **Comunicación**: Siempre explicar qué cambios se están haciendo y por qué
- **Incrementalidad**: Hacer cambios pequeños y probables antes de continuar
- **Documentación**: Actualizar `.context.md` con cambios importantes
- **Usuario primero**: Pensar en la experiencia del usuario peruano
- **Performance**: Optimizar renders y requests a API

---

**Versión del Agente**: 1.0.0  
**Última actualización**: 30 Enero 2026  
**Mantenedor**: Equipo Chapa Tu Venta
